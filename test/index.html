<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HelmJS Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    section {
      margin: 2rem 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    h2 { margin-top: 0; }
    button, a.button {
      padding: 0.5rem 1rem;
      cursor: pointer;
      display: inline-block;
      text-decoration: none;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: inherit;
    }
    a.button:hover { background: #e0e0e0; }
    input, textarea {
      padding: 0.5rem;
      margin: 0.25rem 0;
    }
    #results li {
      padding: 0.5rem;
      background: #f5f5f5;
      margin: 0.25rem 0;
      border-radius: 4px;
    }
    .indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #ccc;
      border-radius: 50%;
      margin-left: 0.5rem;
    }
    .indicator.loading { background: #4caf50; animation: pulse 0.5s infinite; }
    @keyframes pulse { 50% { opacity: 0.5; } }
    .spinner {
      display: none;
      color: #666;
    }
    .spinner.h-loading {
      display: inline;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    a.h-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      overflow-x: auto;
      border-radius: 4px;
    }
    .log {
      font-size: 0.875rem;
      color: #666;
      max-height: 150px;
      overflow-y: auto;
    }
    form { display: inline; }
  </style>
</head>
<body>
  <h1>HelmJS Test Page</h1>
  <p><em>Semantic HTML: h-get on &lt;a&gt; or &lt;form&gt;, h-post/delete on &lt;form&gt;</em></p>

  <!-- Test 1: Basic GET with <a> -->
  <section>
    <h2>1. Basic GET (anchor)</h2>
    <a href="/api/hello" h-get h-target="#hello-result" class="button">Load Message</a>
    <div id="hello-result"><em>Click link to load</em></div>
  </section>

  <!-- Test 2: Swap Strategies -->
  <section>
    <h2>2. Swap Strategies</h2>
    <div>
      <a href="/api/item" h-get h-target="#swap-target" h-swap="inner" class="button">inner</a>
      <a href="/api/item" h-get h-target="#swap-target" h-swap="prepend" class="button">prepend</a>
      <a href="/api/item" h-get h-target="#swap-target" h-swap="append" class="button">append</a>
      <a href="/api/clear" h-get h-target="#swap-target" h-swap="inner" class="button">clear</a>
    </div>
    <div id="swap-target" style="min-height: 50px; margin-top: 1rem; padding: 0.5rem; background: #f9f9f9; border-radius: 4px;">
      <em>Target area</em>
    </div>
  </section>

  <!-- Test 3: Morph (focus preservation) -->
  <section>
    <h2>3. Morph - Focus Preservation (default swap)</h2>
    <p>Type in the input, then click refresh. Your text should be preserved!</p>
    <a href="/api/morph-demo" h-get h-target="#morph-container" class="button">Refresh (morph default)</a>
    <a href="/api/morph-demo" h-get h-target="#morph-container" h-swap="inner" class="button">Refresh with innerHTML</a>
    <div id="morph-container">
      <input type="text" id="search-input" placeholder="Type here..." style="margin: 1rem 0; display: block;">
      <ul id="results">
        <li id="r1">Item 1</li>
        <li id="r2">Item 2</li>
        <li id="r3">Item 3</li>
      </ul>
      <p>Counter: <span id="counter">0</span></p>
    </div>
  </section>

  <!-- Test 4: Form POST -->
  <section>
    <h2>4. Form POST</h2>
    <form action="/api/form" h-post h-target="#form-result">
      <div><input name="name" placeholder="Your name"></div>
      <div><input name="email" type="email" placeholder="Your email"></div>
      <button type="submit">Submit</button>
    </form>
    <div id="form-result"></div>
  </section>

  <!-- Test 5: Throttle -->
  <section>
    <h2>5. Throttle (1000ms)</h2>
    <p>Click rapidly - only fires once per second</p>
    <a href="/api/time" h-get h-target="#throttle-result" h-trigger="click throttle:1000" class="button">
      Get Time (throttled)
    </a>
    <div id="throttle-result"></div>
  </section>

  <!-- Test 6: Events -->
  <section>
    <h2>6. Event Hooks</h2>
    <a href="/api/slow" h-get h-target="#event-result" id="event-link" class="button">
      Load (watch events below)
    </a>
    <span class="indicator" id="loading-indicator"></span>
    <div id="event-result"></div>
    <div class="log" id="event-log"></div>
  </section>

  <!-- Test 7: DELETE with Confirm (form-based) -->
  <section>
    <h2>7. DELETE with Confirm</h2>
    <div id="delete-list">
      <div id="item-1" style="padding: 0.5rem; background: #f5f5f5; margin: 0.25rem 0; border-radius: 4px;">
        Item 1
        <form action="/api/item/1" h-delete h-target="#item-1" h-swap="outer" h-confirm="Delete Item 1?">
          <button type="submit">Delete</button>
        </form>
      </div>
      <div id="item-2" style="padding: 0.5rem; background: #f5f5f5; margin: 0.25rem 0; border-radius: 4px;">
        Item 2
        <form action="/api/item/2" h-delete h-target="#item-2" h-swap="outer" h-confirm="Delete Item 2?">
          <button type="submit">Delete</button>
        </form>
      </div>
      <div id="item-3" style="padding: 0.5rem; background: #f5f5f5; margin: 0.25rem 0; border-radius: 4px;">
        Item 3
        <form action="/api/item/3" h-delete h-target="#item-3" h-swap="outer" h-confirm="Delete Item 3?">
          <button type="submit">Delete</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Test 8: Auto-Disable for Mutations -->
  <section>
    <h2>8. Auto-Disable for Mutations</h2>
    <p>POST auto-disables. GET (on anchors) needs explicit <code>h-disabled</code>.</p>
    <form action="/api/slow" h-post h-target="#disabled-result-1">
      <button type="submit">POST (auto-disables)</button>
    </form>
    <a href="/api/slow" h-get h-target="#disabled-result-2" class="button">
      GET (no auto-disable)
    </a>
    <a href="/api/slow" h-get h-target="#disabled-result-3" h-disabled class="button">
      GET with h-disabled
    </a>
    <form action="/api/slow" h-post h-target="#disabled-result-4" h-no-disable>
      <button type="submit">POST with h-no-disable</button>
    </form>
    <div id="disabled-result-1"></div>
    <div id="disabled-result-2"></div>
    <div id="disabled-result-3"></div>
    <div id="disabled-result-4"></div>
  </section>

  <!-- Test 9: Loading Indicator -->
  <section>
    <h2>9. Loading Indicator</h2>
    <p>Spinner shows during request</p>
    <a href="/api/slow" h-get h-target="#indicator-result" h-indicator="#spinner" class="button">
      Load with Spinner
    </a>
    <span id="spinner" class="spinner">Loading...</span>
    <div id="indicator-result"></div>
  </section>

  <!-- Test 10: Custom Headers -->
  <section>
    <h2>10. Custom Headers</h2>
    <p>Check console/network tab for custom headers</p>
    <a href="/api/headers" h-get h-target="#headers-result"
       h-headers='{"X-Custom-Token": "abc123", "X-Request-Id": "req-456"}' class="button">
      Send with Custom Headers
    </a>
    <div id="headers-result"></div>
  </section>

  <!-- Test 11: h-select (extract fragment) -->
  <section>
    <h2>11. h-select (extract fragment)</h2>
    <p>Server returns full page, but we only extract the #content div</p>
    <a href="/api/full-page" h-get h-target="#select-result" h-select="#content" class="button">
      Load Full Page, Extract #content
    </a>
    <div id="select-result"></div>
  </section>

  <!-- Test 12: h-error-target -->
  <section>
    <h2>12. h-error-target</h2>
    <p>Error responses go to a separate target</p>
    <a href="/api/maybe-error" h-get h-target="#success-result" h-error-target="#error-result" class="button">
      Load (50% chance of error)
    </a>
    <div id="success-result" style="color: green;"></div>
    <div id="error-result" style="color: red;"></div>
  </section>

  <!-- Test 13: History (h-push-url) -->
  <section>
    <h2>13. History (h-push-url / h-replace-url)</h2>
    <p>Click links and watch the URL change. Use browser back/forward buttons!</p>
    <nav style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
      <a href="/page/home" h-get h-target="#history-content" h-push-url class="button">Home</a>
      <a href="/page/about" h-get h-target="#history-content" h-push-url class="button">About</a>
      <a href="/page/contact" h-get h-target="#history-content" h-push-url class="button">Contact</a>
      <a href="/page/replace" h-get h-target="#history-content" h-replace-url class="button">Replace (no history)</a>
    </nav>
    <div id="history-content" style="padding: 1rem; background: #f9f9f9; border-radius: 4px;">
      <p><em>Click a link above to navigate. URL will update and back button will work!</em></p>
    </div>
  </section>

  <!-- Test 14: h-scroll -->
  <section>
    <h2>14. Scroll Control (h-scroll)</h2>
    <p>Click links to load content and scroll</p>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
      <a href="/api/long-content" h-get h-target="#scroll-target" h-scroll="top" class="button">Load & Scroll Top</a>
      <a href="/api/long-content" h-get h-target="#scroll-target" h-scroll="bottom" class="button">Load & Scroll Bottom</a>
      <a href="/api/long-content" h-get h-target="#scroll-target" h-scroll="target" class="button">Load & Scroll to Target</a>
      <a href="/api/long-content" h-get h-target="#scroll-target" h-scroll="#scroll-anchor" class="button">Load & Scroll to #anchor</a>
    </div>
    <div id="scroll-anchor" style="padding: 0.5rem; background: #e3f2fd; border-radius: 4px; margin-bottom: 1rem;">
      This is #scroll-anchor - "Scroll to #anchor" will scroll here
    </div>
    <div id="scroll-target" style="max-height: 200px; overflow-y: auto; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Content will load here</em>
    </div>
  </section>

  <!-- Test 15: h-trigger="intersect" -->
  <section>
    <h2>15. Intersection Observer (h-trigger="intersect")</h2>
    <p>Scroll down to trigger automatic loading (infinite scroll pattern)</p>
    <div id="intersect-list" style="max-height: 200px; overflow-y: auto; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 1</div>
      <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 2</div>
      <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 3</div>
      <a href="/api/more-items" h-get h-trigger="intersect once" h-target="#intersect-list" h-swap="append"
         style="display: block; padding: 1rem; text-align: center; background: #e3f2fd; border-radius: 4px;">
        ‚è≥ Loading more when visible...
      </a>
    </div>
    <p><small>Scroll inside the box above to trigger the intersection observer</small></p>
  </section>

  <!-- Test 16: h-oob (Out-of-Band) -->
  <section>
    <h2>16. Out-of-Band Updates (h-oob)</h2>
    <p>Single response updates multiple elements</p>
    <form action="/api/post-with-oob" h-post h-target="#oob-timeline">
      <input name="content" placeholder="Write something..." style="width: 200px;">
      <button type="submit">Post</button>
    </form>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
      <div>
        <h4>Timeline (main target)</h4>
        <div id="oob-timeline" style="min-height: 100px; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
          <em>Posts appear here</em>
        </div>
      </div>
      <div>
        <h4>Stats (updated via OOB)</h4>
        <div id="oob-stats" style="padding: 0.5rem; background: #e8f5e9; border-radius: 4px;">
          Post count: <span id="post-count">0</span>
        </div>
        <div id="oob-last-post" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
          Last post: <span id="last-post-time">Never</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Test 17: h-poll -->
  <section>
    <h2>17. Polling (h-poll)</h2>
    <p>Auto-refresh content at intervals</p>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
      <div>
        <h4>Every 2s</h4>
        <div h-poll="/api/poll-time 2s" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
          Waiting for first poll...
        </div>
      </div>
      <div>
        <h4>Every 5s (custom target)</h4>
        <div h-poll="/api/poll-count 5s" h-target="#poll-target-custom">
          <div id="poll-target-custom" style="padding: 0.5rem; background: #e3f2fd; border-radius: 4px;">
            Waiting for first poll...
          </div>
        </div>
      </div>
      <div>
        <h4>With OOB (3s)</h4>
        <div h-poll="/api/poll-oob 3s" h-target="#poll-main">
          <div id="poll-main" style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">Main content</div>
        </div>
        <div id="poll-oob-status" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
          OOB status: waiting
        </div>
      </div>
    </div>
  </section>

  <!-- Test 18: h-get on Forms -->
  <section>
    <h2>18. h-get on Forms (Query Params)</h2>
    <p>Forms with h-get serialize data as query parameters</p>
    <form action="/api/search" h-get h-target="#form-get-result">
      <input name="q" placeholder="Search query" value="test">
      <input name="category" placeholder="Category" value="books">
      <button type="submit">Search (GET)</button>
    </form>
    <div id="form-get-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Submit to see query params in URL</em>
    </div>
  </section>

  <!-- Test 19: Multiple Triggers -->
  <section>
    <h2>19. Multiple Triggers (Comma-Separated)</h2>
    <p>Form triggers on both debounced input AND submit</p>
    <form action="/api/search" h-get h-target="#multi-trigger-result" h-trigger="input debounce:500 from:#multi-input, submit">
      <input id="multi-input" name="q" placeholder="Type to search (500ms debounce) or press Enter">
      <button type="submit">Search</button>
    </form>
    <div id="multi-trigger-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Results appear here</em>
    </div>
    <p><small>Try typing slowly (debounce fires) or pressing Enter/clicking button (submit fires)</small></p>
  </section>

  <!-- Test 20: from: Modifier -->
  <section>
    <h2>20. from: Modifier (Cross-Element Events)</h2>
    <p>Form listens for input events from a separate element</p>
    <input id="external-input" placeholder="Type here (external input)" style="margin-bottom: 0.5rem; display: block; width: 100%; box-sizing: border-box;">
    <form action="/api/search" h-get h-target="#from-result" h-trigger="input debounce:300 from:#external-input">
      <input name="q" id="from-hidden-q" type="hidden">
      <span style="color: #666;">Form listens to #external-input above</span>
    </form>
    <div id="from-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Results appear here when you type in the input above</em>
    </div>
  </section>

  <!-- Test 21: h-sync="abort" -->
  <section>
    <h2>21. h-sync="abort" (Cancel In-Flight)</h2>
    <p>New requests abort previous ones - prevents race conditions</p>
    <form action="/api/slow-search" h-get h-target="#sync-abort-result" h-trigger="input debounce:200 from:#sync-abort-input, submit" h-sync="abort">
      <input id="sync-abort-input" name="q" placeholder="Type rapidly to test abort">
      <button type="submit">Search</button>
    </form>
    <div id="sync-abort-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Only the last request's result should appear</em>
    </div>
    <div id="sync-abort-log" class="log" style="margin-top: 0.5rem;"></div>
    <p><small>Watch the log - aborted requests show "ABORTED"</small></p>
  </section>

  <!-- Test 22: h-sync="drop" -->
  <section>
    <h2>22. h-sync="drop" (Ignore New Requests)</h2>
    <p>New requests are dropped while one is in-flight</p>
    <a href="/api/slow" h-get h-target="#sync-drop-result" h-sync="drop" class="button" id="sync-drop-link">
      Click Multiple Times (only first fires)
    </a>
    <div id="sync-drop-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
      <em>Click the button rapidly</em>
    </div>
    <div id="sync-drop-log" class="log" style="margin-top: 0.5rem;"></div>
  </section>

  <!-- Test 23: Live Search (Full Example) -->
  <section>
    <h2>23. Live Search (Complete Example)</h2>
    <p>Combines: h-get on form, multiple triggers, from:, and h-sync="abort"</p>
    <form action="/api/live-search" h-get h-target="#live-search-result"
          h-trigger="input debounce:300 from:#live-search-q, submit"
          h-sync="abort"
          h-indicator="#live-search-spinner">
      <input id="live-search-q" name="q" placeholder="Search users..." autocomplete="off">
      <button type="submit">Search</button>
      <span id="live-search-spinner" class="spinner">Searching...</span>
    </form>
    <div id="live-search-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; min-height: 100px;">
      <em>Start typing to search...</em>
    </div>
  </section>

  <!-- Test 24: SSE (Mock) -->
  <section>
    <h2>24a. Server-Sent Events (Mock)</h2>
    <p>Simulated SSE - click buttons to send mock messages.</p>
    <button onclick="sendSSE('notification', '&lt;div class=\'notif\'&gt;üîî New notification at ' + new Date().toLocaleTimeString() + '&lt;/div&gt;')" class="button">
      Send Notification
    </button>
    <button onclick="sendSSE('message', '&lt;p&gt;üí¨ Message: Hello at ' + new Date().toLocaleTimeString() + '&lt;/p&gt;')" class="button">
      Send Message
    </button>
    <button onclick="sendSSE(null, '&lt;p&gt;üì® Default event at ' + new Date().toLocaleTimeString() + '&lt;/p&gt;')" class="button">
      Send Default
    </button>

    <!-- SSE container with event routing -->
    <div id="sse-container" h-sse="/events" h-target="#sse-default" h-swap="prepend">
      <template h-sse-on="notification" h-target="#sse-notifications" h-swap="prepend"></template>
      <template h-sse-on="message" h-target="#sse-messages" h-swap="append"></template>
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
      <div>
        <h4>Notifications (prepend)</h4>
        <div id="sse-notifications" style="min-height: 80px; padding: 0.5rem; background: #fff3cd; border-radius: 4px;"></div>
      </div>
      <div>
        <h4>Messages (append)</h4>
        <div id="sse-messages" style="min-height: 80px; padding: 0.5rem; background: #d1ecf1; border-radius: 4px;"></div>
      </div>
      <div>
        <h4>Default (prepend)</h4>
        <div id="sse-default" style="min-height: 80px; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;"></div>
      </div>
    </div>
  </section>

  <!-- Test 24b: SSE (Real) -->
  <section>
    <h2>24b. Server-Sent Events (Real Endpoint)</h2>
    <p>Connect to a real SSE endpoint. This uses the native EventSource to test real servers.</p>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
      <input type="text" id="sse-url-input" placeholder="Enter SSE endpoint URL..." style="flex: 1; padding: 0.5rem;">
      <button onclick="connectRealSSE()" class="button">Connect</button>
      <button onclick="disconnectRealSSE()" class="button">Disconnect</button>
    </div>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
      <input type="text" id="sse-events-input" placeholder="Event names to listen for (comma-separated, e.g. note,eose)" style="flex: 1; padding: 0.5rem;" value="message,note,eose">
    </div>
    <div id="sse-real-status" style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Status: Not connected</div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
      <div style="min-width: 0;">
        <h4>Raw Messages (log)</h4>
        <div id="sse-real-output" style="min-height: 150px; max-height: 300px; overflow-y: auto; overflow-x: hidden; padding: 0.5rem; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 0.75rem; word-break: break-all;">
          <em>Raw SSE data will appear here...</em>
        </div>
      </div>
      <div style="min-width: 0;">
        <h4>Rendered HTML (swapped)</h4>
        <div id="sse-real-rendered" style="min-height: 150px; max-height: 300px; overflow-y: auto; overflow-x: hidden; padding: 0.5rem; background: #e8f5e9; border-radius: 4px; word-break: break-all;">
          <em>If server sends HTML, it will render here...</em>
        </div>
      </div>
    </div>
  </section>

  <!-- Test 25: h-focus -->
  <section>
    <h2>25. Focus Control (h-focus)</h2>
    <p>Focus an element after swap completes - useful for chat/message interfaces</p>
    <form action="/api/message" h-post h-target="#focus-result" h-focus="#focus-input">
      <input id="focus-input" name="message" placeholder="Type a message..." autocomplete="off" style="width: 200px;">
      <button type="submit">Send</button>
    </form>
    <div id="focus-result" style="margin-top: 0.5rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; min-height: 50px;">
      <em>Messages appear here. After sending, focus returns to input.</em>
    </div>
    <p><small>After submit, cursor automatically returns to the input field for quick follow-up messages.</small></p>
  </section>

  <script src="../dist/helm.js"></script>
  <script>
    // Mock server responses (intercept fetch)
    let counter = 0;
    let itemCounter = 0;
    let postCount = 0;
    let pollCount = 0;
    let searchRequestId = 0;

    window.fetch = async (url, options = {}) => {
      console.log(`[HelmJS] ${options.method || 'GET'} ${url}`);

      // Simulate network delay
      await new Promise(r => setTimeout(r, 200));

      const path = new URL(url, location.origin).pathname;
      const search = new URL(url, location.origin).searchParams;

      let html = '';

      if (path === '/api/hello') {
        html = `<p><strong>Hello from server!</strong> Time: ${new Date().toLocaleTimeString()}</p>`;
      }
      else if (path === '/api/item') {
        itemCounter++;
        html = `<div class="item">Item ${itemCounter} (added ${new Date().toLocaleTimeString()})</div>`;
      }
      else if (path === '/api/clear') {
        html = `<em>Cleared</em>`;
      }
      else if (path === '/api/morph-demo') {
        counter++;
        html = `
          <input type="text" id="search-input" placeholder="Type here..." style="margin: 1rem 0; display: block;">
          <ul id="results">
            <li id="r1">Updated A (${new Date().toLocaleTimeString()})</li>
            <li id="r2">Updated B</li>
            <li id="r3">Updated C</li>
            <li id="r4">New Item D</li>
          </ul>
          <p>Counter: <span id="counter">${counter}</span></p>
        `;
      }
      else if (path === '/api/form') {
        const body = options.body;
        const data = {};
        for (const [key, val] of body.entries()) {
          data[key] = val;
        }
        html = `<p style="color: green;">Received: ${JSON.stringify(data)}</p>`;
      }
      else if (path === '/api/time') {
        html = `<p>Time: ${new Date().toLocaleTimeString()}</p>`;
      }
      else if (path === '/api/slow') {
        await new Promise(r => setTimeout(r, 800));
        html = `<p>Loaded after 1 second delay</p>`;
      }
      else if (path.startsWith('/api/item/')) {
        // DELETE - return empty to remove element
        html = '';
      }
      else if (path === '/api/headers') {
        const hdrs = Object.fromEntries(Object.entries(options.headers || {}));
        html = `<pre>${JSON.stringify(hdrs, null, 2)}</pre>`;
      }
      else if (path === '/api/full-page') {
        // Returns a full HTML page, but we only want #content
        html = `
          <!DOCTYPE html>
          <html>
            <head><title>Full Page</title></head>
            <body>
              <header><h1>Header - should not appear</h1></header>
              <div id="content">
                <p><strong>This is the extracted content!</strong></p>
                <p>Time: ${new Date().toLocaleTimeString()}</p>
              </div>
              <footer>Footer - should not appear</footer>
            </body>
          </html>
        `;
      }
      else if (path === '/api/maybe-error') {
        const isError = Math.random() > 0.5;
        if (isError) {
          return new Response('<p>Something went wrong! (Error from server)</p>', {
            status: 500,
            headers: { 'Content-Type': 'text/html' }
          });
        }
        html = `<p>Success! Time: ${new Date().toLocaleTimeString()}</p>`;
      }
      else if (path.startsWith('/page/')) {
        const page = path.split('/')[2];
        const pages = {
          home: '<h3>Home Page</h3><p>Welcome to the home page!</p>',
          about: '<h3>About Page</h3><p>This is the about page. Learn more about us.</p>',
          contact: '<h3>Contact Page</h3><p>Get in touch with us here.</p>',
          replace: '<h3>Replaced!</h3><p>This used replace-url, so no history entry was added.</p>'
        };
        html = pages[page] || `<h3>Page: ${page}</h3><p>Unknown page</p>`;
        html += `<p><small>Loaded at: ${new Date().toLocaleTimeString()}</small></p>`;
      }
      // New feature tests
      else if (path === '/api/long-content') {
        html = '<div style="padding: 1rem;">';
        for (let i = 1; i <= 20; i++) {
          html += `<p>Line ${i}: Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>`;
        }
        html += '</div>';
      }
      else if (path === '/api/more-items') {
        html = `
          <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 4 (loaded via intersect)</div>
          <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 5 (loaded via intersect)</div>
          <div class="item" style="padding: 1rem; margin: 0.5rem 0; background: #fff; border-radius: 4px;">Item 6 (loaded via intersect)</div>
          <p style="text-align: center; color: #666;">No more items</p>
        `;
      }
      else if (path === '/api/post-with-oob') {
        const body = options.body;
        const content = body.get('content') || 'Empty post';
        postCount++;
        const time = new Date().toLocaleTimeString();
        // Main response goes to timeline
        html = `<div style="padding: 0.5rem; margin: 0.25rem 0; background: #fff; border-radius: 4px;">
          <strong>Post #${postCount}:</strong> ${content} <small>(${time})</small>
        </div>`;
        // OOB updates go to other targets
        html += `<div id="oob-stats" h-oob="outer" style="padding: 0.5rem; background: #e8f5e9; border-radius: 4px;">
          Post count: <span id="post-count">${postCount}</span>
        </div>`;
        html += `<div id="oob-last-post" h-oob="outer" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
          Last post: <span id="last-post-time">${time}</span>
        </div>`;
      }
      else if (path === '/api/poll-time') {
        html = `<div>Time: ${new Date().toLocaleTimeString()}</div>`;
      }
      else if (path === '/api/poll-count') {
        pollCount++;
        html = `<div>Poll #${pollCount} at ${new Date().toLocaleTimeString()}</div>`;
      }
      else if (path === '/api/poll-oob') {
        pollCount++;
        html = `<div>Main: Poll #${pollCount}</div>`;
        html += `<div id="poll-oob-status" h-oob="outer" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
          OOB status: Updated at ${new Date().toLocaleTimeString()} (poll #${pollCount})
        </div>`;
      }
      // New v0.3.0 feature tests
      else if (path === '/api/search') {
        const q = search.get('q') || '';
        const category = search.get('category') || '';
        html = `<div>
          <p><strong>Search Results</strong></p>
          <p>Query: "${q}"</p>
          ${category ? `<p>Category: "${category}"</p>` : ''}
          <p>URL: ${url}</p>
          <p><small>Time: ${new Date().toLocaleTimeString()}</small></p>
        </div>`;
      }
      else if (path === '/api/slow-search') {
        const q = search.get('q') || '';
        const requestId = ++searchRequestId;
        const abortLog = document.getElementById('sync-abort-log');
        if (abortLog) abortLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] Request #${requestId} started for "${q}"</div>`;

        try {
          await new Promise((resolve, reject) => {
            const timeout = setTimeout(resolve, 600 + Math.random() * 400);
            options.signal?.addEventListener('abort', () => {
              clearTimeout(timeout);
              reject(new DOMException('Aborted', 'AbortError'));
            });
          });
          if (abortLog) abortLog.innerHTML += `<div style="color: green;">[${new Date().toLocaleTimeString()}] Request #${requestId} completed</div>`;
          html = `<div>
            <p>Results for "${q}" (request #${requestId})</p>
            <p><small>Completed at: ${new Date().toLocaleTimeString()}</small></p>
          </div>`;
        } catch (e) {
          if (abortLog) abortLog.innerHTML += `<div style="color: red;">[${new Date().toLocaleTimeString()}] Request #${requestId} ABORTED</div>`;
          throw e;
        }
      }
      else if (path === '/api/live-search') {
        const q = search.get('q') || '';
        await new Promise(r => setTimeout(r, 300 + Math.random() * 200));
        const users = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
        const filtered = q ? users.filter(u => u.toLowerCase().includes(q.toLowerCase())) : users;
        html = `<div>
          <p><strong>${filtered.length} result(s) for "${q}"</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            ${filtered.map(u => `<li>${u}</li>`).join('')}
          </ul>
          <p><small>Searched at: ${new Date().toLocaleTimeString()}</small></p>
        </div>`;
      }
      else if (path === '/api/message') {
        const body = options.body;
        const message = body.get('message') || '';
        const time = new Date().toLocaleTimeString();
        html = `<div style="padding: 0.25rem 0; border-bottom: 1px solid #eee;">
          <strong>${time}:</strong> ${message || '<em>empty message</em>'}
        </div>`;
      }

      return new Response(html, {
        status: 200,
        headers: { 'Content-Type': 'text/html' }
      });
    };

    // Event logging
    const log = document.getElementById('event-log');
    const indicator = document.getElementById('loading-indicator');
    const eventLink = document.getElementById('event-link');

    ['h:before', 'h:after', 'h:swapped', 'h:error'].forEach(evt => {
      eventLink.addEventListener(evt, (e) => {
        const time = new Date().toLocaleTimeString();
        log.innerHTML = `<div>[${time}] ${evt}</div>` + log.innerHTML;

        if (evt === 'h:before') indicator.classList.add('loading');
        if (evt === 'h:swapped' || evt === 'h:error') indicator.classList.remove('loading');
      });
    });

    // h-sync="drop" logging
    const syncDropLink = document.getElementById('sync-drop-link');
    const syncDropLog = document.getElementById('sync-drop-log');
    let dropClickCount = 0;
    if (syncDropLink && syncDropLog) {
      syncDropLink.addEventListener('click', () => {
        dropClickCount++;
        syncDropLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] Click #${dropClickCount}</div>`;
      });
      syncDropLink.addEventListener('h:before', () => {
        syncDropLog.innerHTML += `<div style="color: blue;">[${new Date().toLocaleTimeString()}] Request started</div>`;
      });
      syncDropLink.addEventListener('h:swapped', () => {
        syncDropLog.innerHTML += `<div style="color: green;">[${new Date().toLocaleTimeString()}] Request completed</div>`;
      });
    }

    // Copy external input value to hidden form field for from: test
    const externalInput = document.getElementById('external-input');
    const hiddenQ = document.getElementById('from-hidden-q');
    if (externalInput && hiddenQ) {
      externalInput.addEventListener('input', () => {
        hiddenQ.value = externalInput.value;
      });
    }

    // Mock SSE - store reference to dispatch events manually
    let mockSSE = null;
    const OriginalEventSource = window.EventSource;
    window.EventSource = class MockEventSource {
      constructor(url) {
        console.log('[HelmJS] SSE connecting to:', url);
        this.url = url;
        this.readyState = 1;
        this.onmessage = null;
        this.onerror = null;
        this._listeners = {};
        mockSSE = this;
      }
      addEventListener(event, handler) {
        if (!this._listeners[event]) this._listeners[event] = [];
        this._listeners[event].push(handler);
      }
      close() {
        this.readyState = 2;
        mockSSE = null;
      }
      // Helper to dispatch events
      _dispatch(event, data) {
        const msgEvent = new MessageEvent(event || 'message', { data });
        if (event && this._listeners[event]) {
          this._listeners[event].forEach(h => h(msgEvent));
        } else if (!event && this.onmessage) {
          this.onmessage(msgEvent);
        }
      }
    };

    function sendSSE(event, data) {
      if (mockSSE) {
        mockSSE._dispatch(event, data);
      } else {
        console.warn('SSE not connected');
      }
    }

    // Real SSE connection
    let realSSE = null;
    const sseStatus = document.getElementById('sse-real-status');
    const sseOutput = document.getElementById('sse-real-output');
    const sseRendered = document.getElementById('sse-real-rendered');

    function connectRealSSE() {
      const url = document.getElementById('sse-url-input').value.trim();
      if (!url) {
        alert('Please enter an SSE endpoint URL');
        return;
      }

      disconnectRealSSE();
      sseOutput.innerHTML = '';
      sseRendered.innerHTML = '';
      sseStatus.textContent = 'Status: Connecting...';
      sseStatus.style.color = '#856404';

      try {
        realSSE = new OriginalEventSource(url);

        realSSE.onopen = (e) => {
          console.log('SSE onopen fired', e);
          sseStatus.textContent = 'Status: Connected';
          sseStatus.style.color = '#155724';
          logSSE('system', 'Connected to ' + url);
        };

        realSSE.onmessage = (e) => {
          console.log('SSE onmessage fired', e);
          logSSE('message', e.data);
          // Also render as HTML (prepend)
          sseRendered.insertAdjacentHTML('afterbegin', e.data);
        };

        // Get event names from input
        const eventNamesInput = document.getElementById('sse-events-input').value;
        const eventNames = eventNamesInput.split(',').map(s => s.trim()).filter(s => s);

        logSSE('system', 'Listening for events: ' + eventNames.join(', '));

        // Listen for specified event names
        eventNames.forEach(eventName => {
          realSSE.addEventListener(eventName, (e) => {
            console.log(`SSE event "${eventName}" received:`, e.data);
            logSSE('message', `[${eventName}] ${e.data}`);
            sseRendered.insertAdjacentHTML('afterbegin', `<div style="margin: 0.25rem 0; padding: 0.25rem; background: #fff; border-radius: 2px;">${e.data}</div>`);
          });
        });

        realSSE.onerror = () => {
          if (realSSE.readyState === EventSource.CLOSED) {
            sseStatus.textContent = 'Status: Disconnected';
            sseStatus.style.color = '#721c24';
            logSSE('error', 'Connection closed');
          } else {
            sseStatus.textContent = 'Status: Reconnecting...';
            sseStatus.style.color = '#856404';
            logSSE('error', 'Connection error, reconnecting...');
          }
        };
      } catch (err) {
        sseStatus.textContent = 'Status: Error';
        sseStatus.style.color = '#721c24';
        logSSE('error', 'Failed to connect: ' + err.message);
      }
    }

    function disconnectRealSSE() {
      if (realSSE) {
        realSSE.close();
        realSSE = null;
        sseStatus.textContent = 'Status: Disconnected';
        sseStatus.style.color = '#666';
      }
    }

    function logSSE(type, data) {
      const time = new Date().toLocaleTimeString();
      const colors = { system: '#666', message: '#000', error: '#721c24' };
      const prefix = { system: '‚öôÔ∏è', message: 'üì®', error: '‚ùå' };
      sseOutput.innerHTML += `<div style="color: ${colors[type]}; margin: 0.25rem 0;">[${time}] ${prefix[type]} ${escapeHtml(data)}</div>`;
      sseOutput.scrollTop = sseOutput.scrollHeight;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
